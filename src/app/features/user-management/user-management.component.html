<div class="user-management-container">
  <div class="management-header">
    <div class="header-title">
      <h1>Gestion des Utilisateurs</h1>
      <p>Gérer les utilisateurs de l'application et leurs rôles</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn-outline" (click)="openAddRoleModal()">
        <span class="material-icons">edit_note</span>
        Gérer Rôles
      </button>
      <button type="button" class="btn-add" (click)="openForm()">
        <span class="material-icons">add</span>
        Ajouter un nouvel utilisateur
      </button>
    </div>
  </div>

  <div class="search-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input 
        type="text" 
        placeholder="Rechercher par nom ou email..." 
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
        class="search-input"
      >
    </div>
  </div>

  <!-- User Form Modal -->
  @if (showForm()) {
    <div class="modal-overlay" (click)="closeForm()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ isEditing() ? 'Modifier l\'utilisateur' : 'Ajouter un nouvel utilisateur' }}</h2>
          <button class="close-btn" (click)="closeForm()">
            <span class="material-icons">close</span>
          </button>
        </div>

        @if (errorMessage()) {
          <div class="error-banner">{{ errorMessage() }}</div>
        }

        <form class="user-form" (ngSubmit)="saveUser()">
          <div class="form-group">
            <label>Prénom *</label>
            <input 
              type="text" 
              [(ngModel)]="formData.prenom" 
              name="prenom"
              class="form-input"
              required
            >
          </div>

          <div class="form-group">
            <label>Nom *</label>
            <input 
              type="text" 
              [(ngModel)]="formData.nom" 
              name="nom"
              class="form-input"
              required
            >
          </div>

          <div class="form-group">
            <label>Email *</label>
            <input 
              type="email" 
              [(ngModel)]="formData.email" 
              name="email"
              class="form-input"
              required
            >
          </div>
          @if (!isEditing()) {
            <div class="form-group">
              <label>Mot de passe *</label>
              <input 
                type="password" 
                [(ngModel)]="formData.password" 
                name="password"
                class="form-input"
                required
                placeholder="Définir un mot de passe"
              >
            </div>
          } @else {
            <div class="form-group">
              <label>Nouveau mot de passe (laisser vide pour ne pas changer)</label>
              <input 
                type="password" 
                [(ngModel)]="formData.password" 
                name="passwordEdit"
                class="form-input"
                placeholder="Optionnel"
              >
            </div>
          }


          <div class="form-group">
            <label>Rôle</label>
            <select [(ngModel)]="formData.role" name="role" class="form-select">
              @for (role of roles(); track role.value) {
                <option [value]="role.value">{{ role.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Statut</label>
            <select [(ngModel)]="formData.status" name="status" class="form-select">
              <option value="active">Actif</option>
              <option value="inactive">Inactif</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeForm()">
              Annuler
            </button>
            <button type="submit" class="btn-save" [disabled]="saving()">
              {{ saving() ? 'Enregistrement...' : (isEditing() ? 'Mettre à jour' : 'Créer') }} l'utilisateur
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Users Table -->
  <div class="users-table-container">
    @if (filteredUsers().length > 0) {
      <table class="users-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Statut</th>
            <th>Créé</th>
            <th>Dernière connexion</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.id) {
            <tr>
              <td>{{ user.prenom }} {{ user.nom }}</td>
              <td>{{ user.email }}</td>
              <td>
                <span class="role-badge">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
              <td>
                <span class="status-badge" [class.active]="user.status === 'active'" [class.inactive]="user.status === 'inactive'">
                  {{ user.status === 'active' ? 'Actif' : 'Inactif' }}
                </span>
              </td>
              <td>{{ user.lastLogin | date: 'short' }}</td>
              <td>{{ (user.lastLogin | date: 'short') || 'Jamais' }}</td>
              <td>
                <div class="actions">
                  <button class="btn-icon edit" title="Edit" (click)="openForm(user)">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="btn-icon toggle" title="Toggle Status" (click)="toggleStatus(user)">
                    <span class="material-icons">{{ user.status === 'active' ? 'block' : 'check_circle' }}</span>
                  </button>
                  <button class="btn-icon delete" title="Delete" (click)="deleteUser(user)">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    } @else {
      <div class="empty-state">
        <span class="material-icons">people</span>
        <p>Aucun utilisateur trouvé</p>
      </div>
    }
  </div>
</div>

<!-- Add Custom Role Modal -->
@if (showAddRoleModal()) {
  <div class="modal-overlay" (click)="closeAddRoleModal()">
    <div class="modal small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Ajouter un rôle personnalisé</h2>
        <button class="close-btn" (click)="closeAddRoleModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Nom du rôle *</label>
          <input 
            type="text" 
            placeholder="Saisir le nom du rôle..."
            [value]="newCustomRoleName()"
            (input)="newCustomRoleName.set($any($event.target).value)"
            (keyup.enter)="saveCustomRole()"
            class="form-input"
            autofocus
          >
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="closeAddRoleModal()">Annuler</button>
        <button type="button" class="btn-save" (click)="saveCustomRole()" [disabled]="!newCustomRoleName().trim()">
          <span class="material-icons">add</span>
          Ajouter
        </button>
      </div>
    </div>
  </div>
}
