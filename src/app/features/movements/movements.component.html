<div class="movements-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Mouvements de Stock</h1>
      <p class="page-subtitle">Gérer les entrées et sorties de stock</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-success" (click)="openAddModal('entry')">
        <span class="material-icons">add_circle</span>
        Entrée
      </button>
      <button class="btn btn-danger" (click)="openAddModal('exit')">
        <span class="material-icons">remove_circle</span>
        Sortie
      </button>
      <button class="btn btn-outline" (click)="openAddReasonModal()">
        <span class="material-icons">edit_note</span>
        Gérer Raisons
      </button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card entry">
      <div class="card-icon">
        <span class="material-icons">arrow_downward</span>
      </div>
      <div class="card-content">
        <span class="card-value">{{ summary().totalEntries }}</span>
        <span class="card-label">Entrées</span>
      </div>
      <div class="card-qty">+{{ summary().entriesQuantity }} unités</div>
    </div>
    
    <div class="summary-card exit">
      <div class="card-icon">
        <span class="material-icons">arrow_upward</span>
      </div>
      <div class="card-content">
        <span class="card-value">{{ summary().totalExits }}</span>
        <span class="card-label">Sorties</span>
      </div>
      <div class="card-qty">-{{ summary().exitsQuantity }} unités</div>
    </div>
    
    <div class="summary-card net" [class.positive]="summary().netChange >= 0" [class.negative]="summary().netChange < 0">
      <div class="card-icon">
        <span class="material-icons">{{ summary().netChange >= 0 ? 'trending_up' : 'trending_down' }}</span>
      </div>
      <div class="card-content">
        <span class="card-value">{{ summary().netChange >= 0 ? '+' : '' }}{{ summary().netChange }}</span>
        <span class="card-label">Variation Nette</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input 
        type="text" 
        placeholder="Rechercher par numéro, produit..."
        [value]="searchTerm()"
        (input)="onSearch($event)"
      >
    </div>
    
    <div class="filter-tabs">
      <button 
        class="tab-btn" 
        [class.active]="selectedType() === 'all'"
        (click)="onTypeChange('all')"
      >Tous</button>
      <button 
        class="tab-btn entry" 
        [class.active]="selectedType() === 'entry'"
        (click)="onTypeChange('entry')"
      >Entrées</button>
      <button 
        class="tab-btn exit" 
        [class.active]="selectedType() === 'exit'"
        (click)="onTypeChange('exit')"
      >Sorties</button>
    </div>
    
    <select class="filter-select" (change)="onSiteChange($event)">
      <option value="">Tous les sites</option>
      @for (site of sites(); track site.id) {
        <option [value]="site.id">{{ site.nom }}</option>
      }
    </select>
  </div>

  <!-- Movements Table -->
  <div class="table-container">
    <table class="movements-table">
      <thead>
        <tr>
          <th>Numéro</th>
          <th>Type</th>
          <th>Produit</th>
          <th>Quantité</th>
          <th>Raison</th>
          <th>Site</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (movement of movements(); track movement.id) {
          <tr>
            <td class="movement-number">{{ movement.id }}</td>
            <td>
              <span class="type-badge" [class]="movement.type">
                <span class="material-icons">
                  {{ movement.type === 'entry' ? 'arrow_downward' : 'arrow_upward' }}
                </span>
                {{ movement.type === 'entry' ? 'Entrée' : 'Sortie' }}
              </span>
            </td>
            <td>
              <div class="product-info">
                <span class="product-name">{{ movement.produitNom }}</span>
              </div>
            </td>
            <td>
              <span class="quantity" [class]="movement.type">
                {{ movement.type === 'entry' ? '+' : '-' }}{{ movement.quantite }}
              </span>
            </td>
            <td>
              <span class="reason-tag">{{ getReasonLabel(movement.raison) }}</span>
            </td>
            <td>{{ movement.siteNom }}</td>
            <td>
              <div class="date-info">
                <span class="date-relative">{{ getTimeAgo(movement.dateMouvement) }}</span>
                <span class="date-full">{{ formatDate(movement.dateMouvement) }}</span>
              </div>
            </td>
            <td>
              <button class="action-btn" (click)="openViewModal(movement)">
                <span class="material-icons">visibility</span>
              </button>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="8" class="empty-state">
              <span class="material-icons">inbox</span>
              <p>Aucun mouvement trouvé</p>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          @if (modalMode() === 'add') {
            {{ movementType() === 'entry' ? 'Nouvelle Entrée' : 'Nouvelle Sortie' }}
          } @else {
            Détails du Mouvement
          }
        </h2>
        <button class="close-btn" (click)="closeModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="modal-body">
        @if (modalMode() === 'add') {
          <!-- Add Form -->
          <div class="form-grid">
            <div class="form-group">
              <label>Produit *</label>
              <input 
                type="text" 
                placeholder="Nom du produit"
                [value]="formData().productName"
                (input)="updateFormField('productName', $any($event.target).value)"
              >
            </div>
            
            
            <div class="form-group">
              <label>Code-barres</label>
              <div class="input-with-icon">
                <input 
                  type="text" 
                  placeholder="Scanner ou saisir le code-barres"
                  [value]="formData().barcode"
                  (input)="updateFormField('barcode', $any($event.target).value)"
                >
                <button class="scan-btn" title="Scanner">
                  <span class="material-icons">qr_code_scanner</span>
                </button>
              </div>
            </div>
            
            <div class="form-group">
              <label>Quantité *</label>
              <input 
                type="number" 
                min="1"
                placeholder="Quantité"
                [value]="formData().quantity"
                (input)="updateFormField('quantity', +$any($event.target).value)"
              >
            </div>
            
            <div class="form-group">
              <label>Raison *</label>
              <select 
                [value]="formData().reason"
                (change)="updateFormField('reason', $any($event.target).value)"
              >
                <option value="">Sélectionner une raison</option>
                @for (reason of getReasonsByType(movementType()); track reason.value) {
                  <option [value]="reason.value">{{ reason.label }}</option>
                }
              </select>
            </div>
            
            <div class="form-group">
              <label>Site *</label>
              <select 
                [value]="formData().siteId"
                (change)="updateFormField('siteId', $any($event.target).value)"
              >
                <option value="">Sélectionner un site</option>
                @for (site of sites(); track site.id) {
                  <option [value]="site.id">{{ site.nom }}</option>
                }
              </select>
            </div>
            
            <div class="form-group">
              <label>Référence</label>
              <input 
                type="text" 
                placeholder="N° commande, bon de livraison..."
                [value]="formData().reference"
                (input)="updateFormField('reference', $any($event.target).value)"
              >
            </div>
            
            <div class="form-group full-width">
              <label>Notes</label>
              <textarea 
                rows="3"
                placeholder="Notes additionnelles..."
                [value]="formData().notes"
                (input)="updateFormField('notes', $any($event.target).value)"
              ></textarea>
            </div>
          </div>
        } @else {
          <!-- View Details -->
          @if (selectedMovement(); as movement) {
            <div class="detail-grid">
              <div class="detail-item">
                <label>Numéro</label>
                <span>{{ movement.id }}</span>
              </div>
              <div class="detail-item">
                <label>Type</label>
                <span class="type-badge" [class]="movement.type">
                  {{ movement.type === 'entry' ? 'Entrée' : 'Sortie' }}
                </span>
              </div>
              <div class="detail-item">
                <label>Produit</label>
                <span>{{ movement.produitNom }}</span>
              </div>

              <div class="detail-item">
                <label>Quantité</label>
                <span class="quantity" [class]="movement.type">
                  {{ movement.type === 'entry' ? '+' : '-' }}{{ movement.quantite }}
                </span>
              </div>
              <div class="detail-item">
                <label>Raison</label>
                <span>{{ getReasonLabel(movement.raison) }}</span>
              </div>
              <div class="detail-item">
                <label>Site</label>
                <span>{{ movement.siteNom }}</span>
              </div>
              <div class="detail-item">
                <label>Effectué par</label>
                <span>{{ movement.utilisateurNom || '-' }}</span>
              </div>
              <div class="detail-item">
                <label>Date</label>
                <span>{{ formatDate(movement.dateMouvement) }}</span>
              </div>
              @if (movement.note) {
                <div class="detail-item full-width">
                  <label>Notes</label>
                  <span>{{ movement.note }}</span>
                </div>
              }
            </div>
          }
        }
      </div>
      
      <div class="modal-footer">
        @if (modalMode() === 'add') {
          <button class="btn btn-secondary" (click)="closeModal()">Annuler</button>
          <button class="btn btn-primary" (click)="saveMovement()">
            <span class="material-icons">save</span>
            Enregistrer
          </button>
        } @else {
          <button class="btn btn-secondary" (click)="closeModal()">Fermer</button>
        }
      </div>
    </div>
  </div>
}

<!-- Add Custom Reason Modal -->
@if (showAddReasonModal()) {
  <div class="modal-overlay" (click)="closeAddReasonModal()">
    <div class="modal-content small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Ajouter une raison personnalisée</h2>
        <button class="close-btn" (click)="closeAddReasonModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Type de mouvement *</label>
          <select [value]="reasonType()" (change)="reasonType.set($any($event.target).value)">
            <option value="entry">Entrée</option>
            <option value="exit">Sortie</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Raison {{ reasonType() === 'entry' ? 'd\'entrée' : 'de sortie' }} *</label>
          <input 
            type="text" 
            placeholder="Saisir la raison du mouvement..."
            [value]="newCustomReason()"
            (input)="newCustomReason.set($any($event.target).value)"
            (keyup.enter)="saveCustomReason()"
            autofocus
          >
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddReasonModal()">Annuler</button>
        <button class="btn btn-primary" (click)="saveCustomReason()" [disabled]="!newCustomReason().trim()">
          <span class="material-icons">add</span>
          Ajouter
        </button>
      </div>
    </div>
  </div>
}
