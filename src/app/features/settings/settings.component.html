<div class="settings-container">
  <div class="settings-header">
    <div class="header-title">
      <h1>Paramètres</h1>
      <p>Gérer les permissions des rôles de l'application</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn-outline" (click)="resetPermissions()">
        <span class="material-icons">restart_alt</span>
        Reinitialiser
      </button>
    </div>
  </div>

  @if (saved()) {
    <div class="save-notification">
      <span class="material-icons">check_circle</span>
      Permissions mises à jour
    </div>
  }

  <!-- Role Summary Cards -->
  <div class="roles-summary">
    @for (role of roles(); track role.idRole) {
      <div class="role-card">
        <div class="role-card-header" [style.borderColor]="getRoleColor(role)">
          <span class="material-icons" [style.color]="getRoleColor(role)">{{ getRoleIcon(role) }}</span>
          <div class="role-info">
            <h3>{{ getRoleLabel(role) }}</h3>
            <span class="role-desc">{{ role.description }}</span>
          </div>
        </div>
        <div class="role-card-footer">
          <span class="permission-count" [style.color]="getRoleColor(role)">
            {{ permissionCount(role) }}/{{ totalPermissions }}
          </span>
          <span class="permission-label">permissions</span>
        </div>
      </div>
    }
  </div>

  <!-- Permissions Table -->
  <div class="permissions-table-container">
    <table class="permissions-table">
      <thead>
        <tr>
          <th class="module-col">Module</th>
          <th class="permission-col">Permission</th>
          @for (role of roles(); track role.idRole) {
            <th class="role-col">
              <div class="role-header">
                <span class="role-dot" [style.backgroundColor]="getRoleColor(role)"></span>
                {{ getRoleLabel(role) }}
              </div>
            </th>
          }
        </tr>
      </thead>
      <tbody>
        @for (group of permissionGroups; track group.label) {
          @for (perm of group.permissions; track perm.key; let first = $first) {
            <tr [class.group-first]="first">
              @if (first) {
                <td class="module-cell" [attr.rowspan]="group.permissions.length">
                  <div class="module-info">
                    <span class="material-icons">{{ group.icon }}</span>
                    <span>{{ group.label }}</span>
                  </div>
                </td>
              }
              <td class="permission-cell">{{ perm.label }}</td>
              @for (role of roles(); track role.idRole) {
                <td class="checkbox-cell">
                  <label class="checkbox-wrapper">
                    <input
                      type="checkbox"
                      [checked]="hasPermission(role, perm.key)"
                      (change)="togglePermission(role.nom, perm.key)"
                    >
                    <span class="checkmark" [style.--check-color]="getRoleColor(role)"></span>
                  </label>
                </td>
              }
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
</div>
