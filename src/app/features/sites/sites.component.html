<div class="sites-page">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Gestion des Sites</h1>
      <p class="page-subtitle">Administrer les magasins et entrepôts</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openAddModal()">
        <span class="material-icons">add</span>
        Nouveau Site
      </button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon total">
        <span class="material-icons">location_on</span>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ siteStats().total }}</span>
        <span class="stat-label">Total de Sites</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon warehouse">
        <span class="material-icons">warehouse</span>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ siteStats().warehouses }}</span>
        <span class="stat-label">Entrepôts</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon store">
        <span class="material-icons">store</span>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ siteStats().stores }}</span>
        <span class="stat-label">Magasins</span>
      </div>
    </div>
  </div>

  <div class="filters-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input 
        type="text" 
        placeholder="Rechercher par nom, ville..."
        [value]="searchTerm()"
        (input)="onSearch($event)"
      >
    </div>
    <div class="filter-chips">
      <button class="chip" [class.active]="selectedType() === 'all'" (click)="onTypeChange('all')">Tous</button>
      @for (type of siteTypes; track type.value) {
        <button class="chip" [class.active]="selectedType() === type.value" (click)="onTypeChange(type.value)">
          <span class="material-icons">{{ type.icon }}</span>
          {{ type.label }}
        </button>
      }
    </div>
    <button class="view-toggle" (click)="toggleViewMode()">
      <span class="material-icons">{{ viewMode() === 'grid' ? 'view_list' : 'grid_view' }}</span>
    </button>
  </div>

  <div class="sites-container" [class]="viewMode()">
    @for (site of sites(); track site.id) {
      <div class="site-card">
        <div class="card-header">
          <div class="site-icon" [class]="site.type">
            <span class="material-icons">{{ getSiteTypeIcon(site.type) }}</span>
          </div>
          <div class="site-info">
            <h3 class="site-name">{{ site.nom }}</h3>
            <span class="site-location">{{ site.ville }}</span>
          </div>
          <div class="card-actions">
            <button class="action-btn" (click)="openViewModal(site)" title="Voir">
              <span class="material-icons">visibility</span>
            </button>
            <button class="action-btn" (click)="openEditModal(site)" title="Modifier">
              <span class="material-icons">edit</span>
            </button>
            <button class="action-btn delete" (click)="deleteSite(site)" title="Supprimer">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="site-type-badge" [class]="site.type">
            {{ getSiteTypeLabel(site.type) }}
          </div>
          <div class="site-location">
            <span class="material-icons">location_on</span>
            {{ site.adresse }}, {{ site.ville }} {{ site.codeFiscale }}
          </div>
          @if (site.capacite) {
            <div class="capacity-info">
              <span class="material-icons">inventory</span>
              Capacité: {{ site.capacite }} unités
            </div>
          }
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <span class="material-icons">location_off</span>
        <p>Aucun site trouvé</p>
      </div>
    }
  </div>
</div>

@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          @if (modalMode() === 'add') {
            Nouveau Site
          } @else if (modalMode() === 'edit') {
            Modifier le Site
          } @else {
            Détails du Site
          }
        </h2>
        <button class="close-btn" (click)="closeModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        @if (modalMode() === 'view' && selectedSite(); as site) {
          <div class="detail-grid">
            <div class="detail-item">
              <label>Nom</label>
              <span>{{ site.nom }}</span>
            </div>
            <div class="detail-item">
              <label>Type</label>
              <span>{{ getSiteTypeLabel(site.type) }}</span>
            </div>
            <div class="detail-item full-width">
              <label>Adresse</label>
              <span>{{ site.adresse }}, {{ site.ville }} {{ site.codeFiscale }}</span>
            </div>
            @if (site.telephone) {
              <div class="detail-item">
                <label>Téléphone</label>
                <span>{{ site.telephone }}</span>
              </div>
            }
            @if (site.email) {
              <div class="detail-item">
                <label>Email</label>
                <span>{{ site.email }}</span>
              </div>
            }
            @if (site.responsableSite) {
              <div class="detail-item">
                <label>Responsable</label>
                <span>{{ site.responsableSite }}</span>
              </div>
            }
            @if (site.capacite) {
              <div class="detail-item">
                <label>Capacité</label>
                <span>{{ site.capacite }} unités</span>
              </div>
            }
          </div>
        } @else {
          <div class="form-grid">
            <div class="form-group">
              <label>Nom *</label>
              <input type="text" placeholder="Nom du site" [value]="formData().nom"
                (input)="updateFormField('nom', $any($event.target).value)">
            </div>
            <div class="form-group">
              <label>Type *</label>
              <select [value]="formData().type"
                (change)="updateFormField('type', $any($event.target).value)">
                @for (type of siteTypes; track type.value) {
                  <option [value]="type.value">{{ type.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Capacité</label>
              <input type="number" min="0" placeholder="Capacité en unités" [value]="formData().capacite"
                (input)="updateFormField('capacite', +$any($event.target).value)">
            </div>
            <div class="form-group full-width">
              <label>Adresse</label>
              <input type="text" placeholder="Adresse complète" [value]="formData().adresse"
                (input)="updateFormField('adresse', $any($event.target).value)">
            </div>
            <div class="form-group">
              <label>Ville *</label>
              <input type="text" placeholder="Ville" [value]="formData().ville"
                (input)="updateFormField('ville', $any($event.target).value)">
            </div>
            <div class="form-group">
              <label>Code Postal</label>
              <input type="text" placeholder="Code fiscale" [value]="formData().codeFiscale"
                (input)="updateFormField('codeFiscale', $any($event.target).value)">
            </div>
            <div class="form-group">
              <label>Téléphone</label>
              <input type="tel" placeholder="+212 5XX XXX XXX" [value]="formData().telephone"
                (input)="updateFormField('telephone', $any($event.target).value)">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" placeholder="email&#64;example.com" [value]="formData().email"
                (input)="updateFormField('email', $any($event.target).value)">
            </div>
            <div class="form-group">
              <label>Responsable</label>
              <input type="text" placeholder="Nom du responsable" [value]="formData().responsableSite"
                (input)="updateFormField('responsableSite', $any($event.target).value)">
            </div>
          </div>
        }
      </div>
      <div class="modal-footer">
        @if (modalMode() === 'view') {
          <button class="btn btn-secondary" (click)="closeModal()">Fermer</button>
          <button class="btn btn-primary" (click)="openEditModal(selectedSite()!)">
            <span class="material-icons">edit</span> Modifier
          </button>
        } @else {
          <button class="btn btn-secondary" (click)="closeModal()">Annuler</button>
          <button class="btn btn-primary" (click)="saveSite()">
            <span class="material-icons">save</span> Enregistrer
          </button>
        }
      </div>
    </div>
  </div>
}
